<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Details</title>
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/details/body-top.css">
    <link rel="stylesheet" href="css/details/body-bottom.css">
    <link rel="stylesheet" href="css/footer.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat" />

    <!-- Vendor CSS Files -->
    <link href="/Admin/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/Admin/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <!-- Vendor JS Files -->
    <script src="/Admin/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/Admin/assets/vendor/chart.js/chart.umd.js"></script>
    <!-- <script src="assets/vendor/echarts/echarts.min.js"></script> -->
    <!-- <script src="assets/vendor/quill/quill.min.js"></script> -->
    <script src="/Admin/assets/vendor/simple-datatables/simple-datatables.js"></script>
    <script src="/Admin/assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="/Admin/assets/vendor/php-email-form/validate.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/fbda8849fb.js" crossorigin="anonymous"></script>
    <script src="js/commonLayout.js"></script>
    <script src="js/loadSetting.js"></script>
</head>

<body >

    <header></header>

    <main id="main" class="main p-5">

        <div class="pagetitle">
            <h1>Profile</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                    <li class="breadcrumb-item">Users</li>
                    <li class="breadcrumb-item active">Profile</li>
                </ol>
            </nav>
        </div><!-- End Page Title -->

        <section class="section profile">
            <div class="row border-0">
                <div class="col-xl-4 ">

                    <div class="card ">
                        <div class="card-body border-0 profile-card pt-4 d-flex flex-column align-items-center">

                            <img src="/Admin/assets/img/profile-img.jpg" alt="Profile" class="rounded-circle">
                            
                            <div class="social-links mt-2">
                                <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                                <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                                <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="col-xl-8">

                    <div class="card">
                        <div class="card-body pt-3 border-0">
                            <!-- Bordered Tabs -->
                            <ul class="nav nav-tabs nav-tabs-bordered">

                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab"
                                        data-bs-target="#profile-overview">Overview</button>
                                </li>

                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Edit
                                        Profile</button>
                                </li>

                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab"
                                        data-bs-target="#profile-settings">Settings</button>
                                </li>

                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab"
                                        data-bs-target="#profile-change-password">Change Password</button>
                                </li>

                            </ul>
                            <div class="tab-content pt-2">

                                <div class="tab-pane fade show active profile-overview" id="profile-overview">
                                    <h5 class="card-title">Profile Details</h5>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">ID</div>
                                        <div class="col-lg-9 col-md-8" id="customerId"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Full Name</div>
                                        <div class="col-lg-9 col-md-8" id="customerName"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Phone</div>
                                        <div class="col-lg-9 col-md-8" id="customerPhone"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Address</div>
                                        <div class="col-lg-9 col-md-8" id="customerAddress"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Status</div>
                                        <div class="col-lg-9 col-md-8" id="customerStatus"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Point</div>
                                        <div class="col-lg-9 col-md-8" id="customerPoint"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">User Name</div>
                                        <div class="col-lg-9 col-md-8" id="customerUserName"></div>
                                    </div>
                                </div>

                                <div class="tab-pane fade profile-edit pt-3" id="profile-edit">

                                    <!-- Profile Edit Form -->
                                    <form>
                                        

                                        <div class="row mb-3">
                                            <label for="fullName" class="col-md-4 col-lg-3 col-form-label">Full
                                                Name</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="fullName" type="text" class="form-control" id="fullName"
                                                    value="">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="Phone" class="col-md-4 col-lg-3 col-form-label">Phone</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="phone" type="text" class="form-control" id="Phone"
                                                    value="">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="Address"
                                                class="col-md-4 col-lg-3 col-form-label">Address</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="address" type="text" class="form-control" id="Address"
                                                    value="">
                                            </div>
                                        </div>

                                        <div class="text-center">
                                            <button type="button" class="btn btn-primary" id="saveChangesBtn">Save
                                                Changes</button>
                                        </div>
                                    </form><!-- End Profile Edit Form -->

                                </div>



                                <div class="tab-pane fade pt-3" id="profile-change-password">
                                    <!-- Change Password Form -->
                                    <form id="changePasswordForm">
                                        <div class="row mb-3">
                                            <label for="currentPassword"
                                                class="col-md-4 col-lg-3 col-form-label">Current Password</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="currentPassword" type="password" class="form-control"
                                                    id="currentPassword">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="newPassword" class="col-md-4 col-lg-3 col-form-label">New
                                                Password</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="newPassword" type="password" class="form-control"
                                                    id="newPassword">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="renewPassword" class="col-md-4 col-lg-3 col-form-label">Re-enter
                                                New Password</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="renewPassword" type="password" class="form-control"
                                                    id="renewPassword">
                                            </div>
                                        </div>

                                        <div class="text-center">
                                            <button type="button" class="btn btn-primary" id="changePasswordBtn">Change
                                                Password</button>
                                        </div>
                                    </form><!-- End Change Password Form -->
                                </div>

                            </div><!-- End Bordered Tabs -->

                        </div>
                    </div>

                </div>
            </div>
        </section>

    </main><!-- End #main -->


    </div>



    <footer></footer>
</body>

<script>
    $(document).ready(function () {
        // Replace 'YOUR_API_URL' with the actual URL of your API endpoint
        var apiUrl = 'https://localhost:7126/api/Customers/';

        // Replace 'CUSTOMER_ID' with the actual customer ID you want to retrieve
        var token = localStorage.getItem("token");

        if (token) {
            var decodedToken = parseJwt(token);
            var userId = decodedToken.UserId;
            console.log(userId);

            // Gọi API để lấy thông tin khách hàng dựa trên userId
            $.get(apiUrl + userId, function (data) {
                // Xử lý dữ liệu trả về từ API
                displayCustomerInfo(data);
            })
                .fail(function () {
                    // Xử lý trường hợp lỗi
                    $('#customerId').text('Không thể tải thông tin khách hàng.');
                });
        } else {
            // Xử lý trường hợp không có token
            $('#customerId').text('Không có token.');
        }


        //edit
        var apiUrl = 'https://localhost:7126/api/Customers/';

        $.get(apiUrl + userId, function (data) {
            // Hiển thị dữ liệu từ cơ sở dữ liệu vào các trường input
            $('#fullName').val(data.customerName);
            $('#Phone').val(data.customerPhone);
            $('#Address').val(data.customerAddress);
        })

        // Click event for the Save Changes button
        $('#saveChangesBtn').on('click', function () {
            // Get the form data
            var formData = {
                CustomerName: $('#fullName').val(),
                CustomerPhone: $('#Phone').val(),
                CustomerAddress: $('#Address').val()
            };

            // Get the customer ID from your authentication token or wherever it's available
            var token = localStorage.getItem("token");
            var decodedToken = parseJwt(token);
            var customerId = decodedToken.UserId;

            // Make the AJAX request to update the customer
            $.ajax({
                url: apiUrl + customerId,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function () {
                    alert('Profile updated successfully!');
                    // Optionally, you can redirect or perform other actions after successful update
                },
                error: function () {
                    alert('Failed to update profile. Please try again.');
                }
            });
        });


        //pass
        var apiUrl = 'https://localhost:7126/api/Customers/';

            // Replace 'CUSTOMER_ID' with the actual customer ID you want to retrieve
            var token = localStorage.getItem("token");
            var decodedToken = parseJwt(token);
            var customerId = decodedToken.UserId;

            // Click event for the Change Password button
            $('#changePasswordBtn').on('click', function () {
                // Get the form data
                var formData = {
                    CurrentPassword: $('#currentPassword').val(),
                    NewPassword: $('#newPassword').val(),
                    RenewPassword: $('#renewPassword').val()
                };

                // Make the AJAX request to change the password
                $.ajax({
                    url: apiUrl + customerId + '/changepassword',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        alert(response);
                        // Optionally, you can redirect or perform other actions after successful password change
                    },
                    error: function (error) {
                        alert('Failed to change password. ' + error.responseText);
                    }
                });
            });
    });

    // Hàm hiển thị thông tin khách hàng
    function displayCustomerInfo(customer) {
        $('#customerId').text(customer.customerId);
        $('#customerName').text(customer.customerName);
        $('#customerPhone').text(customer.customerPhone);
        $('#customerAddress').text(customer.customerAddress);
        $('#customerStatus').text(customer.customerStatus);
        $('#customerPoint').text(customer.customerPoint);
        $('#customerUserName').text(customer.customerUserName);
    }

    // Hàm parse JWT
    function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }
</script>

</html>